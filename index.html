<!DOCTYPE html>
<html>
<head>
	<title>Places</title>

	<meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link rel="apple-touch-icon" href="apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="apple-touch-icon-114x114.png" />
  <link rel="apple-touch-startup-image" href="apple-touch-startup-image-320x460.png" />
  <link rel="apple-touch-startup-image" sizes="768x1004" href="apple-touch-startup-image-768x1004.png" />
	

	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
	<script src="js/jquery-1.9.1.min.js"></script>
	<script src="js/jquery.mobile-1.3.1.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    
</head>
<body id="page_body">



  <!-- Start of Favorites ALL page -->
  <div data-role="page" id="favorites-all">

    <div data-role="panel" id="mypanel" data-position="left" data-display="push">
        Related content...
    </div><!-- /panel -->

  	<div data-role="header" data-position="fixed">
  	  <a href="#mypanel" data-icon="bars" class="ui-btn-left" data-position="left" data-iconpos="notext">Panel</a>
  		<h1>Favorites</h1>
  	</div><!-- /header -->

  	<div data-role="content">

      <!-- <p>
        <center>
          <div data-role="controlgroup" data-type="horizontal" data-mini="true">
          <a href="#favorites" data-role="button">Now</a>
          <a onClick="favesAll();" href="#" data-role="button" class="ui-btn-active ui-state-persist">All</a>
          </div>
        </center>
      </p> -->

  		<ul id="all-my-favorites" data-role="listview" data-filter="true" data-filter-reveal="false" data-filter-placeholder="Search my favorites..."></ul>
  		
  		<p class="noFavoritesLoaded" style="text-align:center;font-size:20px;padding-top:60px;"></p>
  		

  	</div><!-- /content -->

  	<div data-role="footer" data-id="favorites" data-position="fixed" class="nav-glyphish-example">
  		<div data-role="navbar" class="nav-glyphish-example">
  			<ul>
  				<li><a href="#places" data-transition="slideup" id="beer" data-icon="arrow-u" onclick='getLocation()'>Places</a></li>
  				<!-- <li><a href="#favorites-all" class="ui-btn-active ui-state-persist" id="beer" data-icon="custom">Favorites</a></li> -->
  			</ul>
  		</div><!-- /navbar -->
  	</div><!-- /footer -->

  </div><!-- /page -->
  
  

  <!-- favorited -->
  <div data-role="page" id="favorited">
    
      <!-- Delete dialog -->
      <div data-role="popup" id="popupDeleted">
        <p>Deleted!<p>
      </div>
    
      <div data-role="header">
        <a data-role="button" data-rel="back" data-icon="back">Back</a>
           <h3 id="places-name">Name Goes Here</h3>
        <a href="#popupDeleted" data-icon="delete" class="" data-position-to="window" data-rel="popup" data-transition="fade" onClick="deleteFave();">Delete</a>
      </div>

      <div data-role="content">

          <ul data-role="listview">
            <li>You like <b><span id="FavoritedplaceName"></span></b></li>
            <li>on <b><span id="FavoriteddayofWeek"></span>s</b></li>
            <li>between <b><span id="FavoritedtimeofDay"></span></b></li>
            <li>located at <b><span id="FavoritedlocationName"></span></b></li>
          </ul>

      </div>
  </div>
      <!-- end #favorited -->



<!-- Start of Places page -->
<div data-role="page" id="places">
  
  
	<div data-role="header" data-position="fixed" data-tap-toggle="false">
	  <a href="#favorites-all" data-icon="arrow-d" class="ui-btn-left" data-transition="slidedown" data-iconpos="notext">Back</a>
		<h1>Favorite a place</h1>
		<a href="#" data-icon="refresh" onclick='getLocation()' class="ui-btn-right" data-iconpos="notext">Refresh</a>
	    
	</div><!-- /header -->

	<div data-role="content" id="placesList" data-scrollz="pull">
		
		<!-- <div id="map_canvas" style="width:250px;height:250px"></div> -->	
		
		<ul id="resultsList" data-role="listview" data-filter="true" data-filter-placeholder="Favorite a place">			

		</ul>
		
	</div><!-- /content -->
	

	
</div><!-- /page -->

<script type="text/javascript" charset="utf-8">

  $('#panelPlaces').click(function() {
      $( "#mypanel" ).panel( "close" );
  });
  
  $('#panelFavorites').click(function() {
      $( "#mypanel" ).panel( "close" );
  });

</script>

    

<!-- display -->
<div data-role="page" id="display">
    <div data-role="header">
      <a data-role="button" data-rel="back" data-icon="back">Back</a>
         <h3 id="places-name">Name Goes Here</h3>
      <a href="#popupSaved" data-icon="check" onClick="saveButton();" class="" id="Savebtn" data-position-to="window" data-rel="popup" data-transition="fade">Save</a>
    </div>

	<script type="text/javascript" charset="utf-8">

	loadListFavorites();
	setFavoriteList();
	
	function deleteFave() {
	  //alert("deleted!");
	  var itemKey = $("#places-name").html();
	  localStorage.removeItem('places'+ itemKey);
	  $.mobile.changePage( "#favorites-all", { reverse: true, transition: "slide"} );
	  //refresh the items
	  loadListFavorites();
	  $('#all-my-favorites').listview('refresh');
	  setFavoriteList();
	  if (localStorage.length === 0) {
    	 	$("p.noFavoritesLoaded").html("You have no favorites!");
    };
	  //need to reset the placeIDnumber i think...
	}
	

	
	function loadListFavorites() {
	
      var currentdate = new Date();
      var currentHour = currentdate.getHours();
      var currentnextHour = currentdate.getHours()+1;
      var currentdd = "am";
      
      if (currentHour > 12) {
          currentHour -= 12;
      } else if (currentHour === 0) {
         currentHour = 12;
      }
      if (currentnextHour > 12) {
          currentnextHour -= 12;
          currentdd = "pm";
      } else if (currentnextHour === 0) {
         currentnextHour = 12;
      }
      
      var currentTime = currentHour+"-"+currentnextHour + currentdd;
      //alert(currentTime);
	    
	    $('#all-my-favorites').empty();
		  for (var i = 0; i < localStorage.length; i++){         
	      	var result = JSON.parse( localStorage.getItem(localStorage.key(i)));    
	      	
	      	//load only localstorage ones with the same timestamp as now
          if(result.timeOfDay == currentTime) {
            $('ul#all-my-favorites').append('<li><a href="#favorited" data-transition="slide">' + result.name +'</a></li>');
          }
    	    
	    }
	    
	}

  var placeIDnumber = 0;
      
  function saveButton() {
    
      var currentdate = new Date();
      var currentHour = currentdate.getHours();
      var currentnextHour = currentdate.getHours()+1;
      var currentdd = "am";

      if (currentHour > 12) {
          currentHour -= 12;
      } else if (currentHour === 0) {
         currentHour = 12;
      }
      if (currentnextHour > 12) {
          currentnextHour -= 12;
          currentdd = "pm";
      } else if (currentnextHour === 0) {
         currentnextHour = 12;
      }

      var currentTime = currentHour+"-"+currentnextHour + currentdd;
      //alert(currentTime);
      
  	  placeIDnumber = placeIDnumber + 1;
  	  var places = {};
  	  places.id = placeIDnumber;
  	  places.name = $("#display h3#places-name").html();
  	  places.location = $('#placeLocation').html();
  	  places.timeOfDay = $('#timeofday').html();
  	  places.dayofWeek = $('#dayofweek').html();
      localStorage.setItem( 'places' + $("#display h3").html(), JSON.stringify(places) );	
      //$.mobile.changePage( "#places", { reverse: true, transition: "slide"} );
  
      $('#all-my-favorites').empty(); 

      for (var i = 0; i < localStorage.length; i++){         
        var result = JSON.parse( localStorage.getItem(localStorage.key(i)));          
        
        if(result.timeOfDay == currentTime) {
          $('ul#all-my-favorites').append('<li><a href="#favorited" data-transition="slide">' + result.name +'</a></li>');
        }
      
      }
    
      //if Saved, change the Save button to activated
      //$("#Savebtn").addClass("ui-btn-active");
    
      //doesnt work the first time you save, but works the 2nd time...  has noName the first time you save
      setFavoriteList();
      $("p.noFavoritesLoaded").html("");
      
      //$("#popupSaved").fadeOut('fast');
  }  
  
  // Something is up with this one.  If i comment it out, it works fine  Maybe order of operations?
  //setFavoriteList();
  	
	function setFavoriteList() {
	  var newcurrentItem = 0;
    
    $('#all-my-favorites li').click(function() {
         
        placetext = $(this).text();
        //placetext = $(this).index();
        alert(placetext);
        
        
    });	  
    
    //localStorage.setItem( 'places' + $("#display h3").html(), JSON.stringify(places) );
    
    $('#favorited').on('pagebeforeshow', function() {
       var favoritedName = JSON.parse( localStorage.getItem(localStorage.key(placetext)));
       $(this).find('[data-role=header] .ui-title').text(favoritedName.name);
       $('#FavoritedplaceName').text(favoritedName.name);
       $('#FavoritedlocationName').text(favoritedName.location);
       $('#FavoritedtimeofDay').text(favoritedName.timeOfDay);
       $('#FavoriteddayofWeek').text(favoritedName.dayofWeek);
    });
    
    //refresh the listview
    $('#all-my-favorites').listview('refresh');
    
	}
		
	</script>	

    <div data-role="content"> 
      
      <!-- Saved dialog -->
      <div data-role="popup" id="popupSaved">
        <p>Saved!<p>
      </div>
            
      <ul data-role="listview">
        <li>You like <b><span id="nameofPlace"></span></b></li>
        <li>on <b><span id="dayofweek"></span>s</b></li>
        <li>between <b><span id="timeofday"></span></b></li>
        <li>located at <b><span id="placeLocation"></span></b></li>
      </ul>      
        
    </div>
    <!-- end #display -->

    <script type="text/javascript" charset="utf-8">

      var date = new Date();
      var weekday=new Array(7);
			weekday[0]="Sunday";
			weekday[1]="Monday";
			weekday[2]="Tuesday";
			weekday[3]="Wednesday";
			weekday[4]="Thursday";
			weekday[5]="Friday";
			weekday[6]="Saturday";
			var day = weekday[date.getDay()];
			$("#dayofweek").html(day);

      var dd = "am";
			var hour = date.getHours();
			var nexthour = date.getHours() + 1;
			
			if (hour > 12) {
          hour -= 12;
      } else if (hour === 0) {
         hour = 12;
      }
      
      if (nexthour > 12) {
          nexthour -= 12;
          dd = "pm";
      } else if (nexthour === 0) {
         nexthour = 12;
      }
      
			$("#timeofday").html(hour+"-"+nexthour+dd);
			
    </script>
    
</div>


<script>

  //start searching for a place
	getLocation();
	
	function getLocation()
	  {
	  if (navigator.geolocation)
	    {
	    navigator.geolocation.getCurrentPosition(showPosition,showError);
	    
	    if (localStorage.length === 0) {
      	 	$("p.noFavoritesLoaded").html("You have no favorites!");
      };
	    
	    }
	  else{x.innerHTML='Geolocation is not supported by this browser.';}
	  }


	function showPosition(position)
	  {
	  var latlon=position.coords.latitude+','+position.coords.longitude;
	  var latitude = position.coords.latitude;
	  var longitude = position.coords.longitude;

	  var img_url='http://maps.googleapis.com/maps/api/staticmap?center='
	  +latlon+'&zoom=14&size=400x300&sensor=false';
			
	  // document.getElementById('map_canvas').innerHTML='<img src=http://maps.googleapis.com/maps/api/staticmap?center='+latlon+'&zoom=14&size=400x300&sensor=false>';

    $('#resultsList').empty();

	  //refresh to a blank list    
    var currentItem = 0;	  
	
$.getJSON('https://api.foursquare.com/v2/venues/search?ll='+latitude+','+longitude+'&query=bar&limit=10&client_id=2POUFAUU4ZBJ2MTDOY3S2YHR2NIT52FYW0LUTPHBMNTJFJNQ&client_secret=YFDZI1YWV3ZI5S5SPM2DZJEQIEBPIDJ5XFZBWTIKIQZVQNYM&v=20120101',
	    function(data) {
	       $.each(data.response.venues, function(i,venues){
	         console.log(data.response.venues);
				   $('#resultsList').append('<li><a href="#display" data-transition="slide">' + venues.name + '</a></li>');
	       });
	       $('#resultsList').listview('refresh');
	       $('#resultsList li').click(function() {
             currentItem = $(this).index();
         });	  
         $('#display').on('pagebeforeshow', function() {
           $(this).find('[data-role=header] .ui-title').text(data.response.venues[currentItem].name);
           $('#nameofPlace').text(data.response.venues[currentItem].name);
           $('#placeLocation').text(data.response.venues[currentItem].location.address);
         });     
		});
		
	  } //end showPosition()


	function showError(error)
	  {
	  switch(error.code) 
	    {
	    case error.PERMISSION_DENIED:
	      x.innerHTML='User denied the request for Geolocation.'
	      break;
	    case error.POSITION_UNAVAILABLE:
	      x.innerHTML='Location information is unavailable.'
	      break;
	    case error.TIMEOUT:
	      x.innerHTML='The request to get user location timed out.'
	      break;
	    case error.UNKNOWN_ERROR:
	      x.innerHTML='An unknown error occurred.'
	      break;
	    }
	  }


    
</script>


</body>
</html>